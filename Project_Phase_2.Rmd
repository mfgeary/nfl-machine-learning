---
title: "Project Phase 2"
author: "Marion Geary"
date: '2022-03-27'
output: html_document
---



```{r}
library(nflverse)
library(tidymodels)

official_player_stats <- calculate_player_stats(load_pbp(), weekly = TRUE)

player_stats <- load_player_stats(seasons = most_recent_season(), stat_type = 'offense')

player_stats_kicking <- load_player_stats(seasons = most_recent_season(), stat_type = 'kicking')

combine <- load_combine(seasons = TRUE)

roster <- load_rosters(seasons = most_recent_season())

team_data <- load_teams()

injuries <- load_injuries()

next_gen_pass <- load_nextgen_stats(seasons = most_recent_season(), stat_type = 'passing')

next_gen_rec <- load_nextgen_stats(seasons = most_recent_season(), stat_type = 'receiving')

next_gen_rush <- load_nextgen_stats(seasons = most_recent_season(), stat_type = 'rushing')

snap_counts <- load_snap_counts(seasons = most_recent_season())

pfr_adv_pass <- load_pfr_advstats(seasons = most_recent_season(), stat_type = 'pass', summary_level = 'week')

pfr_adv_rec <- load_pfr_advstats(seasons = most_recent_season(), stat_type = 'rec', summary_level = 'week')

pfr_adv_rush <- load_pfr_advstats(seasons = most_recent_season(), stat_type = 'rush', summary_level = 'week')

pfr_adv_def <- load_pfr_advstats(seasons = most_recent_season(), stat_type = 'def', summary_level = 'week')
```

Joining time

```{r}
roster_off <- roster %>% full_join(official_player_stats, by = c("gsis_id" = "player_id"), suffix = c('', '.off_pl_stat'), keep = FALSE, na_matches = 'never') 

roster_off <- roster_off %>% distinct() %>% select(- (grep(".off_pl_stat", names(roster_off))))

roster_off_pl_kick <- roster_off %>% full_join(player_stats_kicking, by = c("gsis_id" = "player_id", 'week' = 'week'), suffix = c('', '.xyz'), keep = FALSE)
         
roster_off_pl_kick <- roster_off_pl_kick %>%
  distinct() %>%
  select(- (grep(".xyz", names(roster_off_pl_kick))))    

# use official player stats, don't use 'player stats', use player_stats_kick

roster_off_pl_kick_com <- roster_off_pl_kick %>%
  left_join(combine, by = c('pfr_id' = 'pfr_id'), suffix = c('', '.xyz'), keep = FALSE, na_matches = 'never')

roster_off_pl_kick_com <- roster_off_pl_kick_com %>%
  distinct() %>%
  select(- (grep(".xyz", names(roster_off_pl_kick_com)))) 

roster_off_pl_kick_com_team <- roster_off_pl_kick_com %>% left_join(team_data, by = c('team' = 'team_abbr'), suffix = c('', '.xyz'), keep = FALSE)

roster_off_pl_kick_com_team <- roster_off_pl_kick_com_team %>%
  distinct() %>%
  select(- (grep(".xyz", names(roster_off_pl_kick_com_team)))) 

injuries <- injuries %>% mutate(season = as.numeric(season), week = as.numeric(week))

roster_off_pl_kick_com_team_inj <- roster_off_pl_kick_com_team %>%
  left_join(
    injuries,
    by = c('gsis_id' = 'gsis_id', 'season' = 'season', 'week' = 'week'),
    suffix = c('', '.xyz'),
    keep = FALSE
  )

roster_off_pl_kick_com_team_inj <- roster_off_pl_kick_com_team_inj %>%
  distinct() %>%
  select(- (grep(".xyz", names(roster_off_pl_kick_com_team_inj)))) 

all_next_gen <- roster_off_pl_kick_com_team_inj %>%
  left_join(
    next_gen_pass,
    by = c('gsis_id' = 'player_gsis_id', 'season' = 'season', 'week' = 'week'),
    suffix = c('', '.xyz'),
    keep = FALSE
  ) %>% left_join(
    next_gen_rec,
    by = c('gsis_id' = 'player_gsis_id', 'season' = 'season', 'week' = 'week'),
    suffix = c('', '.xyz'),
    keep = FALSE
  ) %>% left_join(
    next_gen_rush,
    by = c('gsis_id' = 'player_gsis_id', 'season' = 'season', 'week' = 'week'),
    suffix = c('', '.xyz'),
    keep = FALSE
  )

all_next_gen <- all_next_gen %>%
  distinct() %>%
  select(- (grep(".xyz", names(all_next_gen))))

all_pfr <- all_next_gen %>% left_join(
    pfr_adv_def,
    by = c('pfr_id' = 'pfr_player_id', 'season' = 'season', 'week' = 'week'),
    suffix = c('', '.xyz'),
    keep = FALSE
  ) %>% left_join(
    pfr_adv_pass,
    by = c('pfr_id' = 'pfr_player_id', 'season' = 'season', 'week' = 'week'),
    suffix = c('', '.xyz'),
    keep = FALSE
  ) %>% left_join(
    pfr_adv_rush,
    by = c('pfr_id' = 'pfr_player_id', 'season' = 'season', 'week' = 'week'),
    suffix = c('', '.xyz'),
    keep = FALSE
  ) %>% left_join(
    pfr_adv_rec,
    by = c('pfr_id' = 'pfr_player_id', 'season' = 'season', 'week' = 'week'),
    suffix = c('', '.xyz'),
    keep = FALSE
  )

all_pfr <- all_pfr %>%
  distinct() %>%
  select(- (grep(".xyz", names(all_pfr))))

all_data <- all_pfr %>% left_join(
  snap_counts,
  by = c('pfr_id' = 'pfr_player_id', 'season' = 'season', 'week' = 'week'),
  suffix = c('', '.xyz'),
  keep = FALSE
)

all_data <- all_data %>%
  distinct() %>%
  select(- (grep(".xyz", names(all_data))))


```

```{r}
all_data <- all_data %>%
  select(-c(espn_id, sportradar_id, yahoo_id, rotowire_id, pff_id, pfr_id, fantasy_data_id, sleeper_id, player_name, cfb_id, pos, date_modified, player_display_name, team_abbr, player_position, player_first_name, player_last_name, player_short_name, player_jersey_number, pfr_game_id, season_type, pfr_player_name, player))


```



```{r}
save.image("nfl-project.Rdata")
```

